# 聊天室系统数据库需求分析文档

## 1. 项目概述

### 1.1 项目背景
本项目旨在开发一个功能完善的多聊天室在线交流系统，支持用户注册登录、多聊天室管理、实时消息交互、文件分享、用户社交等核心功能。

### 1.2 系统目标
- 支持多聊天室并发运行
- 提供完整的用户管理体系
- 实现实时消息传输与管理
- 支持富媒体内容分享
- 提供管理员权限管理功能
- 扩展用户社交功能

---

## 2. 功能需求分析

### 2.1 核心功能模块

#### 2.1.1 用户管理模块
**功能需求：**
- 用户注册功能
  - 用户名、密码、邮箱、手机号等基本信息
  - 用户唯一标识生成
  - 密码加密存储
  
- 用户登录功能
  - 支持用户名/邮箱/手机号登录
  - 登录状态维护
  - 登录历史记录
  
- 用户信息编辑功能
  - 修改昵称、头像、个性签名
  - 修改密码
  - 绑定/解绑联系方式
  
- 用户个人主页功能
  - 展示用户基本信息
  - 展示用户加入的聊天室
  - 展示用户好友列表
  - 展示用户活跃度统计

**数据需求：**
- 用户ID、用户名、昵称、密码（加密）
- 邮箱、手机号
- 头像URL、个性签名
- 注册时间、最后登录时间
- 用户状态（在线/离开/离线）
- 账号状态（正常/禁用/已注销）

#### 2.1.2 聊天室管理模块
**功能需求：**
- 聊天室创建功能
  - 自动生成聊天室ID和密码
  - 设置聊天室名称、描述、图标
  - 设置聊天室类型（公开/私密/需密码）
  - 创建者自动成为管理员
  
- 聊天室查找功能
  - 通过聊天室ID查找
  - 通过聊天室名称模糊搜索
  - 聊天室分类浏览
  
- 聊天室加入/退出功能
  - 公开聊天室直接加入
  - 私密聊天室需要密码
  - 退出聊天室
  - 加入历史记录
  
- 聊天室信息管理
  - 在线人数统计
  - 总成员数统计
  - 已加入用户列表
  - 聊天室设置修改（仅管理员）

**数据需求：**
- 聊天室ID、聊天室名称、描述
- 聊天室密码（加密）
- 聊天室图标URL
- 聊天室类型（公开/私密/需密码）
- 创建者ID、创建时间
- 在线人数、总成员数
- 聊天室状态（正常/已归档/已删除）
- 最后活跃时间

#### 2.1.3 消息管理模块
**功能需求：**
- 消息发送功能
  - 文本消息发送
  - 表情消息发送
  - 消息实时推送
  - 消息已读/未读状态
  
- 消息撤回功能
  - 2分钟内可撤回
  - 撤回后显示"消息已撤回"
  - 撤回记录保留
  
- 消息编辑功能
  - 发送者可编辑自己的消息
  - 管理员可编辑所有消息
  - 显示"已编辑"标识
  - 保留编辑历史
  
- 消息搜索和过滤功能
  - 按关键词搜索
  - 按用户过滤
  - 按时间范围过滤
  - 按消息类型过滤
  
- 消息删除功能
  - 发送者可删除自己的消息
  - 管理员可删除任何消息
  - 删除记录保留

**数据需求：**
- 消息ID、聊天室ID、发送者ID
- 消息内容、消息类型（文本/表情/文件/系统消息）
- 发送时间、编辑时间
- 消息状态（正常/已撤回/已删除）
- 是否已编辑标识
- 引用消息ID（回复功能）
- 已读用户列表

#### 2.1.4 文件分享模块
**功能需求：**
- 文件上传功能
  - 支持多种文件格式
  - 文件大小限制
  - 文件上传进度显示
  
- 文件下载功能
  - 文件预览（图片、PDF等）
  - 文件下载
  - 下载次数统计
  
- 文件管理功能
  - 文件列表展示
  - 文件搜索
  - 文件删除（上传者/管理员）

**数据需求：**
- 文件ID、文件名、文件大小
- 文件类型、文件扩展名
- 文件存储路径、文件URL
- 上传者ID、上传时间
- 所属聊天室ID、关联消息ID
- 下载次数
- 文件状态（正常/已删除）

#### 2.1.5 聊天室成员管理模块
**功能需求：**
- 成员列表展示
  - 按在线状态排序
  - 显示用户头像、昵称、状态
  
- 成员权限管理
  - 普通成员
  - 管理员
  - 所有者
  
- 成员操作功能
  - 踢出成员（管理员权限）
  - 设置/取消管理员（所有者权限）
  - 禁言/解除禁言（管理员权限）

**数据需求：**
- 成员关系ID
- 聊天室ID、用户ID
- 加入时间、最后活跃时间
- 成员角色（所有者/管理员/普通成员）
- 禁言状态、禁言到期时间
- 是否已退出

#### 2.1.6 管理员功能模块
**功能需求：**
- 消息编辑功能
  - 编辑任何用户的消息
  - 删除不当消息
  - 置顶重要消息
  
- 禁言功能
  - 禁言指定用户
  - 设置禁言时长
  - 解除禁言
  - 查看禁言记录
  
- 聊天室管理
  - 修改聊天室信息
  - 设置聊天室公告
  - 归档/删除聊天室

**数据需求：**
- 管理操作日志
  - 操作ID、操作类型
  - 操作者ID、被操作者ID
  - 操作时间、操作原因
  - 操作详情（JSON格式）
- 禁言记录
  - 禁言ID、聊天室ID、用户ID
  - 禁言开始时间、结束时间
  - 禁言原因
  - 操作者ID

#### 2.1.7 超级管理员功能模块
**功能需求：**
- 全局消息管理功能
  - 编辑任何聊天室的任何消息
  - 删除任何聊天室的任何消息
  - 批量管理消息
  - 查看所有消息记录
  
- 全局禁言管理功能
  - 禁言任何聊天室的任何用户
  - 解除任何禁言
  - 设置全局禁言（跨所有聊天室）
  - 查看所有禁言记录
  
- 全局聊天室管理功能
  - 管理所有聊天室设置
  - 删除/归档任何聊天室
  - 设置/取消任何聊天室的管理员
  - 强制解散聊天室
  
- 用户管理功能
  - 禁用/启用用户账号
  - 查看所有用户信息
  - 重置用户密码
  - 删除用户账号
  
- 系统监控功能
  - 查看所有操作日志
  - 系统数据统计
  - 违规内容监控

**数据需求：**
- 用户系统角色标识（user_role）
- 全局禁言记录（global_mute_records）
  - 全局禁言ID
  - 被禁言用户ID
  - 操作者ID（超级管理员）
  - 禁言原因
  - 禁言开始时间、结束时间
  - 是否全局禁言标识
- 超级管理员操作日志（增强版）
  - 包含跨聊天室操作记录

### 2.2 扩展功能模块

#### 2.2.1 用户私聊模块
**功能需求：**
- 发起私聊
- 私聊消息发送/接收
- 私聊消息历史
- 私聊会话管理

**数据需求：**
- 私聊会话ID
- 参与者ID列表
- 会话创建时间
- 最后消息时间
- 未读消息数
- 私聊消息记录（结构类似聊天室消息）

#### 2.2.2 用户好友模块
**功能需求：**
- 添加好友
  - 发送好友请求
  - 接受/拒绝好友请求
  
- 好友管理
  - 好友列表
  - 删除好友
  - 好友备注
  - 好友分组

**数据需求：**
- 好友关系ID
- 用户A ID、用户B ID
- 关系状态（待确认/已同意/已拒绝）
- 添加时间、确认时间
- 好友备注
- 好友分组

---

## 3. 数据实体识别

### 3.1 核心实体

1. **用户实体（User）**
   - 存储用户账号基本信息
   - 用户认证信息
   - 用户状态信息

2. **聊天室实体（ChatRoom）**
   - 存储聊天室基本信息
   - 聊天室配置信息
   - 聊天室统计信息

3. **消息实体（Message）**
   - 存储聊天室消息内容
   - 消息元数据
   - 消息状态信息

4. **聊天室成员实体（ChatRoomMember）**
   - 存储用户与聊天室的关联关系
   - 成员权限信息
   - 成员状态信息

5. **文件实体（File）**
   - 存储文件基本信息
   - 文件存储路径
   - 文件元数据

6. **私聊会话实体（PrivateChat）**
   - 存储私聊会话信息
   - 会话参与者信息

7. **好友关系实体（Friendship）**
   - 存储用户好友关系
   - 好友状态信息

8. **管理操作日志实体（AdminLog）**
   - 存储管理员操作记录
   - 操作详情信息

9. **禁言记录实体（MuteRecord）**
   - 存储用户禁言信息
   - 禁言时效信息

10. **全局禁言记录实体（GlobalMuteRecord）**
   - 存储超级管理员设置的全局禁言信息
   - 跨所有聊天室的禁言记录

---

## 4. 实体关系分析

### 4.1 实体关系图（ER图文字描述）

#### 4.1.1 一对多关系

1. **用户 - 聊天室**（创建关系）
   - 一个用户可以创建多个聊天室
   - 一个聊天室只能由一个用户创建

2. **用户 - 消息**
   - 一个用户可以发送多条消息
   - 一条消息只能由一个用户发送

3. **聊天室 - 消息**
   - 一个聊天室可以包含多条消息
   - 一条消息只能属于一个聊天室

4. **用户 - 文件**
   - 一个用户可以上传多个文件
   - 一个文件只能由一个用户上传

5. **聊天室 - 文件**
   - 一个聊天室可以包含多个文件
   - 一个文件只能属于一个聊天室

6. **用户 - 管理操作日志**
   - 一个用户（管理员）可以有多条操作日志
   - 一条操作日志只对应一个操作者

7. **聊天室 - 禁言记录**
   - 一个聊天室可以有多条禁言记录
   - 一条禁言记录只属于一个聊天室

#### 4.1.2 多对多关系

1. **用户 - 聊天室**（成员关系）
   - 一个用户可以加入多个聊天室
   - 一个聊天室可以有多个用户
   - 通过 ChatRoomMember 实体关联

2. **用户 - 用户**（好友关系）
   - 一个用户可以有多个好友
   - 好友关系是双向的
   - 通过 Friendship 实体关联

3. **用户 - 私聊会话**
   - 一个用户可以参与多个私聊会话
   - 一个私聊会话包含两个用户
   - 通过 PrivateChat 实体关联

#### 4.1.3 自引用关系

1. **消息 - 消息**（回复关系）
   - 一条消息可以回复另一条消息
   - 形成消息引用链

---

## 5. 数据属性分析

### 5.1 用户实体属性

| 属性名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| user_id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 用户唯一标识 |
| username | VARCHAR(50) | UNIQUE, NOT NULL | 用户名（登录用） |
| nickname | VARCHAR(50) | NOT NULL | 用户昵称（显示用） |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希值 |
| email | VARCHAR(100) | UNIQUE, NULL | 邮箱 |
| phone | VARCHAR(20) | UNIQUE, NULL | 手机号 |
| avatar_url | VARCHAR(500) | NULL | 头像URL |
| signature | VARCHAR(200) | NULL | 个性签名 |
| user_role | ENUM | NOT NULL, DEFAULT 'user' | 系统角色（super_admin/user） |
| status | ENUM | NOT NULL, DEFAULT 'offline' | 在线状态（online/away/offline） |
| account_status | ENUM | NOT NULL, DEFAULT 'active' | 账号状态（active/disabled/deleted） |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 注册时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE | 更新时间 |
| last_login_at | DATETIME | NULL | 最后登录时间 |

### 5.2 聊天室实体属性

| 属性名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| room_id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 聊天室唯一标识 |
| room_code | VARCHAR(20) | UNIQUE, NOT NULL | 聊天室邀请码 |
| room_name | VARCHAR(100) | NOT NULL | 聊天室名称 |
| room_description | TEXT | NULL | 聊天室描述 |
| room_icon | VARCHAR(500) | NULL | 聊天室图标URL |
| room_type | ENUM | NOT NULL, DEFAULT 'public' | 聊天室类型（public/private/password） |
| room_password_hash | VARCHAR(255) | NULL | 聊天室密码（仅password类型） |
| creator_id | BIGINT | NOT NULL, FOREIGN KEY | 创建者用户ID |
| member_count | INT | NOT NULL, DEFAULT 0 | 总成员数 |
| online_count | INT | NOT NULL, DEFAULT 0 | 在线人数 |
| status | ENUM | NOT NULL, DEFAULT 'active' | 状态（active/archived/deleted） |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE | 更新时间 |
| last_active_at | DATETIME | NULL | 最后活跃时间 |

### 5.3 消息实体属性

| 属性名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| message_id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 消息唯一标识 |
| room_id | BIGINT | NOT NULL, FOREIGN KEY | 所属聊天室ID |
| sender_id | BIGINT | NOT NULL, FOREIGN KEY | 发送者用户ID |
| message_type | ENUM | NOT NULL, DEFAULT 'text' | 消息类型（text/emoji/file/system） |
| content | TEXT | NOT NULL | 消息内容 |
| reply_to_id | BIGINT | NULL, FOREIGN KEY | 回复的消息ID |
| is_edited | BOOLEAN | NOT NULL, DEFAULT FALSE | 是否已编辑 |
| edited_at | DATETIME | NULL | 编辑时间 |
| status | ENUM | NOT NULL, DEFAULT 'normal' | 状态（normal/recalled/deleted） |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 发送时间 |

### 5.4 聊天室成员实体属性

| 属性名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| member_id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 成员关系唯一标识 |
| room_id | BIGINT | NOT NULL, FOREIGN KEY | 聊天室ID |
| user_id | BIGINT | NOT NULL, FOREIGN KEY | 用户ID |
| role | ENUM | NOT NULL, DEFAULT 'member' | 角色（owner/admin/member） |
| is_muted | BOOLEAN | NOT NULL, DEFAULT FALSE | 是否被禁言 |
| mute_until | DATETIME | NULL | 禁言到期时间 |
| joined_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 加入时间 |
| last_read_at | DATETIME | NULL | 最后读取时间 |
| is_active | BOOLEAN | NOT NULL, DEFAULT TRUE | 是否还在聊天室 |
| left_at | DATETIME | NULL | 退出时间 |

**唯一约束：** (room_id, user_id) 组合唯一

### 5.5 文件实体属性

| 属性名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| file_id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 文件唯一标识 |
| file_name | VARCHAR(255) | NOT NULL | 文件名 |
| file_size | BIGINT | NOT NULL | 文件大小（字节） |
| file_type | VARCHAR(50) | NOT NULL | 文件MIME类型 |
| file_extension | VARCHAR(10) | NOT NULL | 文件扩展名 |
| storage_path | VARCHAR(500) | NOT NULL | 文件存储路径 |
| file_url | VARCHAR(500) | NOT NULL | 文件访问URL |
| uploader_id | BIGINT | NOT NULL, FOREIGN KEY | 上传者用户ID |
| room_id | BIGINT | NOT NULL, FOREIGN KEY | 所属聊天室ID |
| message_id | BIGINT | NULL, FOREIGN KEY | 关联的消息ID |
| download_count | INT | NOT NULL, DEFAULT 0 | 下载次数 |
| status | ENUM | NOT NULL, DEFAULT 'active' | 状态（active/deleted） |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 上传时间 |

### 5.6 私聊会话实体属性

| 属性名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| chat_id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 私聊会话唯一标识 |
| user_a_id | BIGINT | NOT NULL, FOREIGN KEY | 用户A的ID |
| user_b_id | BIGINT | NOT NULL, FOREIGN KEY | 用户B的ID |
| last_message_id | BIGINT | NULL, FOREIGN KEY | 最后一条消息ID |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**唯一约束：** (user_a_id, user_b_id) 组合唯一，且 user_a_id < user_b_id

### 5.7 私聊消息实体属性

| 属性名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| private_message_id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 私聊消息唯一标识 |
| chat_id | BIGINT | NOT NULL, FOREIGN KEY | 私聊会话ID |
| sender_id | BIGINT | NOT NULL, FOREIGN KEY | 发送者用户ID |
| message_type | ENUM | NOT NULL, DEFAULT 'text' | 消息类型（text/emoji/file） |
| content | TEXT | NOT NULL | 消息内容 |
| is_read | BOOLEAN | NOT NULL, DEFAULT FALSE | 是否已读 |
| is_edited | BOOLEAN | NOT NULL, DEFAULT FALSE | 是否已编辑 |
| edited_at | DATETIME | NULL | 编辑时间 |
| status | ENUM | NOT NULL, DEFAULT 'normal' | 状态（normal/recalled/deleted） |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 发送时间 |

### 5.8 好友关系实体属性

| 属性名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| friendship_id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 好友关系唯一标识 |
| user_a_id | BIGINT | NOT NULL, FOREIGN KEY | 用户A的ID |
| user_b_id | BIGINT | NOT NULL, FOREIGN KEY | 用户B的ID |
| status | ENUM | NOT NULL, DEFAULT 'pending' | 状态（pending/accepted/rejected） |
| requester_id | BIGINT | NOT NULL, FOREIGN KEY | 发起请求的用户ID |
| remark_a | VARCHAR(50) | NULL | 用户A对用户B的备注 |
| remark_b | VARCHAR(50) | NULL | 用户B对用户A的备注 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| accepted_at | DATETIME | NULL | 接受时间 |

**唯一约束：** (user_a_id, user_b_id) 组合唯一，且 user_a_id < user_b_id

### 5.9 管理操作日志实体属性

| 属性名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| log_id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 日志唯一标识 |
| room_id | BIGINT | NULL, FOREIGN KEY | 聊天室ID（全局操作时可为NULL） |
| operator_id | BIGINT | NOT NULL, FOREIGN KEY | 操作者用户ID |
| target_id | BIGINT | NULL, FOREIGN KEY | 被操作者用户ID |
| action_type | VARCHAR(50) | NOT NULL | 操作类型（mute/unmute/kick/edit_message/delete_message/global_mute/disable_user等） |
| action_reason | TEXT | NULL | 操作原因 |
| action_detail | JSON | NULL | 操作详情（JSON格式） |
| is_global_action | BOOLEAN | NOT NULL, DEFAULT FALSE | 是否为全局操作（超级管理员） |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 操作时间 |

### 5.10 禁言记录实体属性

| 属性名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| mute_id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 禁言记录唯一标识 |
| room_id | BIGINT | NOT NULL, FOREIGN KEY | 聊天室ID |
| user_id | BIGINT | NOT NULL, FOREIGN KEY | 被禁言用户ID |
| operator_id | BIGINT | NOT NULL, FOREIGN KEY | 操作者用户ID |
| mute_reason | TEXT | NULL | 禁言原因 |
| mute_start_time | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 禁言开始时间 |
| mute_end_time | DATETIME | NOT NULL | 禁言结束时间 |
| is_active | BOOLEAN | NOT NULL, DEFAULT TRUE | 是否生效中 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

### 5.11 全局禁言记录实体属性

| 属性名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| global_mute_id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 全局禁言记录唯一标识 |
| user_id | BIGINT | NOT NULL, FOREIGN KEY | 被禁言用户ID |
| operator_id | BIGINT | NOT NULL, FOREIGN KEY | 操作者用户ID（超级管理员） |
| mute_reason | TEXT | NULL | 禁言原因 |
| mute_start_time | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 禁言开始时间 |
| mute_end_time | DATETIME | NOT NULL | 禁言结束时间 |
| is_active | BOOLEAN | NOT NULL, DEFAULT TRUE | 是否生效中 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**说明：** 全局禁言优先级高于聊天室禁言，被全局禁言的用户在所有聊天室都无法发言

---

## 6. 数据约束与规则

### 6.1 完整性约束

#### 6.1.1 实体完整性
- 所有实体表必须有主键
- 主键值唯一且非空
- 建议使用 BIGINT 自增主键

#### 6.1.2 参照完整性
- 所有外键必须参照存在的主键
- 删除操作需要考虑级联关系：
  - 用户删除：软删除，不物理删除（account_status = 'deleted'）
  - 聊天室删除：软删除（status = 'deleted'），保留历史消息
  - 消息删除：软删除（status = 'deleted'），保留记录
  - 文件删除：软删除（status = 'deleted'），物理文件可延迟清理

#### 6.1.3 用户定义完整性
- 用户名：3-20个字符，仅允许字母、数字、下划线
- 密码：至少8个字符，必须包含字母和数字
- 邮箱：必须符合邮箱格式
- 手机号：必须符合手机号格式
- 聊天室名称：2-50个字符
- 聊天室邀请码：6-20个字符，唯一
- 文件大小：单个文件不超过100MB
- 消息内容：不超过5000个字符

### 6.2 业务规则

#### 6.2.1 用户相关规则
1. 用户名、邮箱、手机号必须全局唯一
2. 用户注册后状态默认为 'offline'
3. 用户最后登录时间在每次登录时更新
4. 用户状态（在线/离开/离线）由前端维护，后端定期更新
5. 超级管理员角色通过 user_role = 'super_admin' 标识
6. 系统至少保留一个超级管理员账号

#### 6.2.2 聊天室相关规则
1. 聊天室创建者自动成为所有者（owner）
2. 聊天室至少有一个所有者
3. 公开聊天室无需密码即可加入
4. 私密聊天室需要邀请码
5. 需密码聊天室需要正确密码
6. 聊天室成员数和在线人数需要实时或定期更新

#### 6.2.3 消息相关规则
1. 消息发送后2分钟内可撤回
2. 消息撤回后状态改为 'recalled'，内容保留
3. 消息编辑后 is_edited 标记为 true，edited_at 更新
4. 被禁言用户无法发送消息
5. 系统消息由系统自动生成（sender_id 可为特殊值）
6. 回复消息时 reply_to_id 指向被回复的消息

#### 6.2.4 权限相关规则
1. 只有所有者可以设置/取消管理员
2. 管理员可以禁言普通成员
3. 所有者不能被禁言或踢出
4. 管理员可以编辑/删除任何消息
5. 普通成员只能编辑/删除自己的消息
6. 所有管理操作必须记录日志
7. **超级管理员权限规则：**
   - 超级管理员可以管理所有聊天室
   - 超级管理员可以编辑/删除任何聊天室的任何消息
   - 超级管理员可以禁言/解除任何用户（包括聊天室所有者）
   - 超级管理员可以设置全局禁言（跨所有聊天室）
   - 超级管理员可以强制解散任何聊天室
   - 超级管理员可以禁用/启用任何用户账号
   - 超级管理员不受聊天室权限限制
   - 超级管理员的所有操作必须记录到管理操作日志
   - 超级管理员账号不能被普通管理员或所有者操作

#### 6.2.5 好友相关规则
1. 好友关系需要双方确认
2. user_a_id < user_b_id 保证关系唯一性
3. 只有好友才能发起私聊
4. 删除好友后私聊历史保留

---

## 7. 性能需求分析

### 7.1 数据量估算

#### 7.1.1 初期数据量（1-6个月）
- 用户数：10,000 - 50,000
- 聊天室数：500 - 2,000
- 日活跃用户：1,000 - 5,000
- 日消息量：50,000 - 200,000
- 文件存储：10GB - 50GB

#### 7.1.2 中期数据量（6个月-2年）
- 用户数：50,000 - 500,000
- 聊天室数：2,000 - 10,000
- 日活跃用户：5,000 - 50,000
- 日消息量：200,000 - 2,000,000
- 文件存储：50GB - 500GB

#### 7.1.3 长期数据量（2年以上）
- 用户数：500,000+
- 聊天室数：10,000+
- 日活跃用户：50,000+
- 日消息量：2,000,000+
- 文件存储：500GB+

### 7.2 索引需求

#### 7.2.1 必需索引
1. **用户表**
   - PRIMARY KEY (user_id)
   - UNIQUE INDEX (username)
   - UNIQUE INDEX (email)
   - UNIQUE INDEX (phone)
   - INDEX (status, account_status) - 查询在线用户
   - INDEX (user_role) - 查询超级管理员

2. **聊天室表**
   - PRIMARY KEY (room_id)
   - UNIQUE INDEX (room_code)
   - INDEX (creator_id) - 查询用户创建的聊天室
   - INDEX (status, room_type) - 浏览公开聊天室

3. **消息表**
   - PRIMARY KEY (message_id)
   - INDEX (room_id, created_at DESC) - 分页查询聊天室消息
   - INDEX (sender_id, created_at DESC) - 查询用户发送的消息
   - INDEX (reply_to_id) - 查询回复链
   - FULLTEXT INDEX (content) - 消息内容全文搜索

4. **聊天室成员表**
   - PRIMARY KEY (member_id)
   - UNIQUE INDEX (room_id, user_id)
   - INDEX (user_id, is_active) - 查询用户加入的聊天室
   - INDEX (room_id, is_active, role) - 查询聊天室成员列表

5. **文件表**
   - PRIMARY KEY (file_id)
   - INDEX (room_id, created_at DESC) - 查询聊天室文件
   - INDEX (uploader_id, created_at DESC) - 查询用户上传的文件

6. **私聊消息表**
   - PRIMARY KEY (private_message_id)
   - INDEX (chat_id, created_at DESC) - 分页查询私聊消息
   - INDEX (sender_id, is_read) - 查询未读消息

7. **好友关系表**
   - PRIMARY KEY (friendship_id)
   - UNIQUE INDEX (user_a_id, user_b_id)
   - INDEX (user_a_id, status) - 查询好友列表
   - INDEX (user_b_id, status) - 查询好友列表

8. **全局禁言记录表**
   - PRIMARY KEY (global_mute_id)
   - INDEX (user_id, is_active) - 查询用户全局禁言状态
   - INDEX (operator_id, created_at DESC) - 查询管理员操作记录
   - INDEX (mute_end_time, is_active) - 定期清理过期禁言

### 7.3 查询优化需求

1. **消息查询优化**
   - 使用分页查询，每页20-50条
   - 按时间倒序查询最新消息
   - 考虑使用消息缓存（Redis）

2. **在线用户统计优化**
   - 使用Redis缓存在线用户列表
   - 定期同步到数据库

3. **未读消息统计优化**
   - 使用计数器表或Redis
   - 避免实时COUNT查询

4. **聊天室列表查询优化**
   - 缓存热门聊天室信息
   - 分页加载

---

## 8. 安全性需求

### 8.1 数据安全

1. **密码安全**
   - 使用 bcrypt 或 Argon2 加密算法
   - 密码加盐处理
   - 密码哈希值不可逆

2. **敏感信息保护**
   - 邮箱、手机号等敏感信息加密存储（可选）
   - API 返回数据时脱敏处理

3. **SQL 注入防护**
   - 使用参数化查询
   - ORM 框架自动防护

4. **访问控制**
   - 基于角色的访问控制（RBAC）
   - 用户只能访问自己有权限的数据

### 8.2 数据备份

1. **定期备份**
   - 每日全量备份
   - 每小时增量备份（可选）

2. **备份存储**
   - 异地备份
   - 多副本存储

3. **灾难恢复**
   - 备份恢复演练
   - RTO（恢复时间目标）< 4小时
   - RPO（恢复点目标）< 1小时

---

## 9. 数据字典

### 9.1 枚举类型定义

#### 9.1.1 用户在线状态（UserStatus）
| 值 | 说明 |
|----|------|
| online | 在线 |
| away | 离开 |
| offline | 离线 |

#### 9.1.2 账号状态（AccountStatus）
| 值 | 说明 |
|----|------|
| active | 正常 |
| disabled | 已禁用 |
| deleted | 已注销 |

#### 9.1.2.1 用户系统角色（UserRole）
| 值 | 说明 |
|----|------|
| super_admin | 超级管理员，拥有全局最高权限 |
| user | 普通用户 |

#### 9.1.3 聊天室类型（RoomType）
| 值 | 说明 |
|----|------|
| public | 公开，任何人可加入 |
| private | 私密，仅邀请 |
| password | 需要密码 |

#### 9.1.4 聊天室状态（RoomStatus）
| 值 | 说明 |
|----|------|
| active | 正常 |
| archived | 已归档 |
| deleted | 已删除 |

#### 9.1.5 消息类型（MessageType）
| 值 | 说明 |
|----|------|
| text | 文本消息 |
| emoji | 表情消息 |
| file | 文件消息 |
| system | 系统消息 |

#### 9.1.6 消息状态（MessageStatus）
| 值 | 说明 |
|----|------|
| normal | 正常 |
| recalled | 已撤回 |
| deleted | 已删除 |

#### 9.1.7 成员角色（MemberRole）
| 值 | 说明 |
|----|------|
| owner | 所有者 |
| admin | 管理员 |
| member | 普通成员 |

#### 9.1.8 好友状态（FriendshipStatus）
| 值 | 说明 |
|----|------|
| pending | 待确认 |
| accepted | 已接受 |
| rejected | 已拒绝 |

#### 9.1.9 文件状态（FileStatus）
| 值 | 说明 |
|----|------|
| active | 正常 |
| deleted | 已删除 |

---

## 10. 需求总结

### 10.1 核心功能实体
1. ✅ 用户（User）- 包含系统角色字段
2. ✅ 聊天室（ChatRoom）
3. ✅ 消息（Message）
4. ✅ 聊天室成员（ChatRoomMember）
5. ✅ 文件（File）
6. ✅ 管理操作日志（AdminLog）
7. ✅ 禁言记录（MuteRecord）
8. ✅ 全局禁言记录（GlobalMuteRecord）- 新增

### 10.2 扩展功能实体
1. ✅ 私聊会话（PrivateChat）
2. ✅ 私聊消息（PrivateMessage）
3. ✅ 好友关系（Friendship）

### 10.3 主要关系
1. ✅ 用户 ←→ 聊天室（多对多，通过 ChatRoomMember）
2. ✅ 用户 → 聊天室（一对多，创建关系）
3. ✅ 用户 → 消息（一对多）
4. ✅ 聊天室 → 消息（一对多）
5. ✅ 用户 ←→ 用户（多对多，好友关系）
6. ✅ 用户 ←→ 用户（多对多，私聊关系）

### 10.4 下一步工作
1. 根据需求分析绘制完整的 ER 图
2. 进行概念模型设计
3. 转换为逻辑模型设计
4. 进行物理模型设计
5. 编写 SQL 建表脚本
6. 设计数据库索引优化方案
7. 设计数据访问接口（API）

---

## 11. 附录

### 11.1 技术栈建议
- **数据库：** MySQL 8.0+ 或 PostgreSQL 13+
- **缓存：** Redis 6.0+
- **ORM 框架：** TypeORM / Sequelize / Prisma
- **后端框架：** Node.js + Express / Nest.js
- **实时通信：** WebSocket / Socket.io
- **文件存储：** 本地存储 / 云存储（OSS/S3）

### 11.2 参考资料
1. 数据库设计规范
2. MySQL 官方文档
3. WebSocket 实时通信协议
4. RESTful API 设计规范

---

**文档版本：** v1.0  
**创建日期：** 2025-11-10  
**作者：** GitHub Copilot  
**状态：** 需求分析阶段完成
